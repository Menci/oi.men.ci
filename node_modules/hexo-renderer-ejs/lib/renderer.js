'use strict';

var ejs = require('ejs');
var assign = require('object-assign');
var cheerio = require('cheerio');

function ejsRenderer(data, locals) {
  let $ = cheerio.load(ejs.render(data.text, assign({filename: data.path}, locals)));
  function applyTo(tag, attr) {
    $(tag).each(function() {
      let e = $(this);
      let val = e.attr(attr);
      if (typeof val === 'undefined' || val.trim() === '') return;
      if (val.startsWith('/') && !val.startsWith('//')) val = 'https://static.cdn.menci.xyz/menci-oi-blog' + val;
      e.attr(attr, val);
    })
  }
  applyTo('img', 'src');
  applyTo('link', 'href');
  applyTo('script', 'src');
  return $.html();
}

module.exports = ejsRenderer;
